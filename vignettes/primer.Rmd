---
title: "Figures for 'A Primer on Visualizations for Comparing Populations...'"
author: "Jerzy Wieczorek"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Figures for 'A Primer on Visualizations for Comparing Populations...'}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE, cache=FALSE}
options(tikzMetricsDictionary="~/Downloads/RankingProject/tikzMetrics")
```

This vignette shows how to reproduce the main figures in "A Primer on Visualizations for Comparing Populations, Including the Issue of Overlapping Confidence Intervals" (Wright, Klein, and Wieczorek, 2017).

TODO: Add figure/table options to use LaTeX vs plain labels.

```{r, dev='tikz', fig.width=6.5, fig.height=8, cache=TRUE}
library(RankingProject)
library(tikzDevice)

USfile  <- system.file("extdata", "USA.csv",
                       package = "RankingProject")
USdata  <- read.csv(USfile, header=TRUE, stringsAsFactors=FALSE)
USdata  <- subset(USdata, Abbreviation != "USA")
refAbbr <- "CO"
refRow  <- which(USdata$Abbreviation==refAbbr)
refRank <- USdata$Rank[refRow]
refName <- USdata$State[refRow]
refEst  <- USdata$Estimate.2dec[refRow]

tableParList <- list(Rank = USdata$Rank, PlaceName = USdata$State, 
                     Est = formatC(USdata$Estimate.2dec,
                                   format = 'f', digits = 2),
                     SE = substring(formatC(round(USdata$SE.2dec, 2),
                                            format = 'f', digits = 2), 2),
                     PlaceType = "State")

figureParList <- list(est = USdata$Estimate.2dec, se = USdata$SE.2dec,
                      names = USdata$Abbreviation, 
                      refName = refAbbr,
                      confLevel = .9)

annotParList <- list(refRank = refRank, refFullName = refName)

# Pantyhose plot
tableParList$pantyhoseRefLine <- .7
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList,
                  annotParList = NULL, figureFunction = PANTYHOSE.rankCompPlot,
                  tablewidthProp = 2/7)
tableParList$pantyhoseRefLine <- NULL

# Individual CIs
figureParList$plotType <- "individual"
figureParList$cex <- 0.6
# figureParList$legendText <- ""  # can remove auto-legend this way
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList,
                  annotParList = NULL, figureFunction = REG.CIs.rankCompPlot)
# figureParList$legendText <- NULL

# CIs for differences from ref
figureParList$lwdBold <- 5
figureParList$plotType <- "difference"
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList,
                  annotParList = annotParList,
                  figureFunction = REG.CIs.rankCompPlot)

# Comparison intervals
figureParList$plotType <- "comparison"
figureParList$thetaLine <- 1.5
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList,
                  annotParList = NULL, figureFunction = REG.CIs.rankCompPlot)
figureParList$thetaLine <- NULL
figureParList$lwdBold <- NULL

# Goldstein-Healy adjusted CIs
figureParList$plotType <- "individual"
figureParList$GH <- TRUE
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList,
                  annotParList = NULL, figureFunction = REG.CIs.rankCompPlot)

# Double-tiered GH plot:
# inner tiers are GH CIs,
# outer tiers are usual 90% CIs
figureParList$tiers <- 2
# Not sure why legend auto-positioning is wonky,
# but we can get around it by controlling X,Y manually
figureParList$legendX <- 12
figureParList$legendY <- 53
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList,
                  annotParList = NULL,
                  figureFunction = REG.CIs.rankCompPlot)

# Double-tiered GH + Bonferroni plot:
# inner tiers are usual 90% CIs,
# outer tiers are 50-way demi-Bonferroni-corrected GH CIs
figureParList$Bonferroni <- "demi"
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList,
                  annotParList = NULL,
                  figureFunction = REG.CIs.rankCompPlot)
```

For this vignette, the plots above were automatically converted to PDF format using `knitr` with chunk option `dev='tikz'`. However, to save plots one at a time "manually," you can explicitly call the `tikz()` function from the `tikzDevice` package, as in the following example (not run).

The `tikz()` function works much like `pdf()` or `png()` and other functions for saving plots from R scripts. Remember to call `dev.off()` after the plotting function runs.

This will create and save a `.tex` file. You will need to compile it into a PDF separately, or you can use `texi2pdf()` which compiles the PDF and saves it in the current working directory.

```{r, eval=FALSE}
# Not run:
library(tikzDevice)
tikz("/path/to/my/file.tex", standAlone = TRUE, width = 6.5, height = 8)
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList,
                  annotParList = NULL,
                  figureFunction = double.REG.CIs.rankCompPlot)
dev.off()
texi2pdf("/path/to/my/file.tex")
```

