---
title: "Figures for 'A Primer on Visualizations for Comparing Populations...'"
author: "Jerzy Wieczorek"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Figures for 'A Primer on Visualizations for Comparing Populations...'}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE, cache=FALSE}
options(tikzMetricsDictionary="~/Downloads/RankingProject/tikzMetrics")
```

This vignette shows how to reproduce the main figures in "A Primer on Visualizations for Comparing Populations, Including the Issue of Overlapping Confidence Intervals" (Wright, Klein, and Wieczorek, 2017).

```{r, dev='tikz', fig.width=6.5, fig.height=8, cache=FALSE}
library(RankingProject)
library(tikzDevice)

# TODO: drop USA row (or add an example using it as reference "state"?);
# resave in .Rdata format; add a documentation file for the dataset too
USfile  <- system.file("extdata", "USA.csv",
                       package = "RankingProject")
USdata  <- read.csv(USfile, header=TRUE, stringsAsFactors=FALSE)
USdata  <- subset(USdata, Abbreviation != "USA")
head(USdata)

# Format estimates and SEs into strings with 2 digits past the decimal
USdata$Estimate.Print = formatC(USdata$Estimate.2dec,
                                format = 'f', digits = 2)
# For SEs, also drop the leading 0
USdata$SE.Print = substring(formatC(USdata$SE.2dec,
                                    format = 'f', digits = 2),
                            first = 2)

# Set Colorado as the reference state
refAbbr <- "CO"
refRow  <- which(USdata$Abbreviation==refAbbr)

# Set up parameter lists for table function, figure function, and annotations
tableParList <- with(USdata,
                     list(ranks = Rank, names = State, 
                          est = Estimate.Print, se = SE.Print,
                          placeType = "State", tikzText = TRUE))

figureParList <- with(USdata,
                      list(est = Estimate.2dec, se = SE.2dec,
                           names = Abbreviation, refName = refAbbr,
                           confLevel = .9, tikzText = TRUE))

annotParList <- with(USdata,
                     list(refRank = Rank[refRow],
                          refFullName = State[refRow], tikzText = TRUE))

# Pantyhose plot
figureParList$plotType <- "columns"
tableParList$pantyhoseRefLine <- .7
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList,
                  tablewidthProp = 2/7)
tableParList$pantyhoseRefLine <- NULL

# Individual CIs
figureParList$plotType <- "individual"
figureParList$cex <- 0.6
# figureParList$legendText <- ""  # can remove auto-legend this way
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList)
# figureParList$legendText <- NULL

# CIs for differences from ref
figureParList$lwdBold <- 5
figureParList$plotType <- "difference"
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList,
                  annotParList = annotParList)

# Comparison intervals
figureParList$plotType <- "comparison"
figureParList$thetaLine <- 1.5
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList)
figureParList$thetaLine <- NULL
figureParList$lwdBold <- NULL

# Goldstein-Healy adjusted CIs
figureParList$plotType <- "individual"
figureParList$GH <- TRUE
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList)

# Double-tiered GH plot:
# inner tiers are GH CIs,
# outer tiers are usual 90% CIs
figureParList$tiers <- 2
# Legend auto-positioning is poor with line breaks in legend text;
# we can improve it by controlling (X,Y) manually
figureParList$legendX <- 12
figureParList$legendY <- 53
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList)

# Double-tiered GH + Bonferroni plot:
# inner tiers are usual 90% CIs,
# outer tiers are 50-way demi-Bonferroni-corrected GH CIs
figureParList$Bonferroni <- "demi"
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList)
```

For this vignette, the plots above were automatically converted to PDF format using `knitr` with chunk option `dev='tikz'`. However, to save plots one at a time "manually," you can explicitly call the `tikz()` function from the `tikzDevice` package, as in the following example (not run).

The `tikz()` function works much like `pdf()` or `png()` and other functions for saving plots from R scripts. Remember to call `dev.off()` after the plotting function runs.

This will create and save a `.tex` file. You will need to compile it into a PDF separately, or you can use `texi2pdf()` which compiles the PDF and saves it in the current working directory.

```{r, eval=FALSE}
# Not run:
library(tikzDevice)
tikz("/path/to/my/file.tex", standAlone = TRUE, width = 6.5, height = 8)
RankPlotWithTable(tableParList = tableParList, figureParList = figureParList,
                  annotParList = NULL,
                  figureFunction = double.REG.CIs.rankCompPlot)
dev.off()
texi2pdf("/path/to/my/file.tex")
```

